# CSV for OT-2
`pdjson2py` converts JSON file to CSV file, which is further converted to Python script. This two step conversion allow users to modify the protocol in a spreadsheet software such as Excel or Google Sheets. The project is inintially developed to provide csv2py conversion, where CSV file is generated by external program.
The CSV file is a sort of composite of multiple colomn rules, to express the protocol in a single file. The first column is always the step number, and the second column is the step type. The rest of the columns are different for each step type. The following is the list of step types and the column definition for each step type.

# Conversion Logic
## 1. Convert metadata and load pipette, labware, and module information
As step 0, metadata, loading module, labware, and pipette information is converted to CSV. 
|Col. 0|Col. 1|Col. 2|Col. 3|Col. 4|Col. 5|Col. 6|
|---|---|---|---|---|---|---|
|Step#|Step Type|Comment|Load Name|Mount/Location|ID|Tiprack|
* Note that this column label is not printed in the csv file.

### 1-1. Metadata
#### Source
- pdjson['metadata']
#### Column Definition
0. Step#: 0 (integral)
1. Step Type: "Initialize" (fixed string)
2. Comment: "Metadata" (fixed string)
3. Source Labware: key of pdjson['metadata'] (str)
4. Source Slot: value of pdjson['metadata'] (str, for `tag`, value is in list format.)
### 1-2. Default values
#### Source
- pdjson['designerApplication']['data']['defaultValues']
#### Column Definition
0. Step#: 0 (integral)
1. Step Type: "Initialize" (fixed string)
2. Comment: "Metadata" (fixed string)
3. Source Labware: simplified keys according to key of pdjson['designerApplication']['data']['defaultValues']:
    - `aspirate_mmFromBottom` -> "aspirate_offset"
    - `dispense_mmFromBottom` -> "dispense_offset"
    - `touchTip_mmFromTop` -> "touch_tip_offset"
    - `blowout_mmFromTop` -> "blowout_offset"
4. Source Slot: value of pdjson['designerApplication']['data']['defaultValues'] (float)

### 1-3. Load Modules
#### Source
- pdjson['commands'][i]['param'] (pdjson['commands'][i]['commandType'] == 'loadModule')
#### Column Definition
0. Step#: 0 (integral)
1. Step Type: "Initialize" (fixed string)
2. Comment: "Load Module" (fixed string)
3. Load Name: pdjson['commands'][i]['param']['model'] (str)
4. Mount/Location pdjson['commands'][i]['param']['location']['slotName'] (str, '1'-'11')
5. ID: pdjson['commands'][i]['param']['moduleId'] (str)   # Used to specify location of labware

### 1-4. Load Labware
Loading labware follows module loading, as a part of labware is stacked on the module.
#### Source
- pdjson['commands'][i]['param'] (pdjson['commands'][i]['commandType'] == 'loadLabware')
#### Column Definition
0. Step#: 0 (integral)
1. Step Type: "Initialize" (fixed string)
2. Comment: "Load Labware" (fixed string)
3. Load Name: pdjson['commands'][i]['param']['loadName'] (str)
4. Mount/Location: pdjson['commands'][i]['param']['location']['slotName'] (str, '1'-'11') or pdjson['commands'][i]['param']['location']['moduleId'] (str, defined in advance in column 5)
5. ID: pdjson['commands'][i]['param']['labwareId'] (str)   # Used to specify location of stacked labware

### 1-5. Load Pipettes
Loading pipette follows labware loading, as tipracks have to be loaded before pipettes.
#### Source
- pdjson['commands'][i]['param'] (pdjson['commands'][i]['commandType'] == 'loadPipette')
- pipette: dict (key: pipetteId, value: mount) # used to convert pipette ID, specfied in liquid handling steps, to pipette object.
#### Column Definition
0. Step#: 0 (integral)
1. Step Type: "Initialize" (fixed string)
2. Comment: "Load Pipette" (fixed string)
3. Load Name: pdjson['commands'][i]['param']['pipetteName'] (str)
4. Mount/Location: pdjson['commands'][i]['param']['mount'] (str, 'left' or 'right')
5. ID: pdjson['commands'][i]['param']['pipetteId'] (str)   # Used to specify location of pipette
6. Tiprack: pdjson['designerApplication']['data']['pipettesTiprackAssignments'][{pdjson['commands'][i]['param']['pipetteId']}] (str)

## 2-1. Column Definition for transfer
From step 1 to the end, the following column definition is used for transfer steps.
|Col. 0|Col. 1|Col. 2|Col. 3|Col. 4|Col. 5|Col. 6|Col. 7|Col. 8|Col. 9|Col. 10|Col. 11|Col. 12|Col. 13|Col. 14|Col. 15|Col. 16|Col. 17|Col. 18|Col. 19|Col. 20|Col. 21|Col. 22|Col. 23|Col. 24|Col. 25|Col. 26|Col. 27|



0. Step# (Integral serial, shown in generated protocol)
    - list index of pdjson['designerApplication']['data']['orderedStepIds][list index] storing stepId + 1 (starting from 1)
1. Step Type [Transfer]
    - fixed string "Transfer"
2. Comment (Step comment at the top row of each step)
3. Source Labware (labware API name)
4. Source Slot (str, 1-11 or A1,A2... for future OT Flex support)
5. Source Well (str)
6. Source Volume (float in µL)
7. Source Name (str, the last word can be hex color code starting from #)
8. Dest Labware (labware API name)
9. Dest Slot (str, 1-11 or A1,A2... for future OT Flex support)
10. Dest Well (str)
11. Dest Volume (float in µL)
12. Dest Name (the last word can be hex color code starting from #)
13. Handling Volume (float in µL)
14. Change Tip ([blank]|always|per source|per destination|once|never)
15. Aspirate Rate (int, 1-6)
16. Prewet Cycle (int)
17. Source Delay (int, sec)
18. Source Touch Tip (float, speed 0.25-1)
19. Source Air Gap (flaot, in µL)
20. Dispense Rate (int, 1-6)
21. Pipetting Cycle (int)
22. Dest Delay (int, sec)
23. Dest Touch Tip (flaot, speed 0.25-1)
24. Dest Air Gap (int, in uL)
25. Reverse Mode ([blank]|Bin|Source)
26. Distribute (No|Allow|Force [Bin|Source])
27. Pipette




## Column Definition (for transfer)
0. Step# (Integral serial, shown in generated protocol)
1. Step Type [Transfer|Mix]
2. Comment (Step comment at the top row of each step)
3. Source Labware (labware API name)
4. Source Slot (str, 1-11 or A1,A2... for future OT Flex support)
5. Source Well (str)
6. Source Volume (float in µL)
7. Source Name (str, the last word can be hex color code starting from #)
8. Dest Labware (labware API name)
9. Dest Slot (str, 1-11 or A1,A2... for future OT Flex support)
10. Dest Well (str)
11. Dest Volume (float in µL)
12. Dest Name (the last word can be hex color code starting from #)
13. Handling Volume (float in µL)
14. Change Tip ([blank]|always|per source|per destination|once|never)
15. Aspirate Rate (int, 1-6)
16. Prewet Cycle (int)
17. Source Delay (int, sec)
18. Source Touch Tip (float, speed 0.25-1)
19. Source Air Gap (flaot, in µL)
20. Dispense Rate (int, 1-6)
21. Pipetting Cycle (int)
22. Dest Delay (int, sec)
23. Dest Touch Tip (flaot, speed 0.25-1)
24. Dest Air Gap (int, in uL)
25. Reverse Mode ([blank]|Bin|Source)
26. Distribute (No|Allow|Force [Bin|Source])
27. Pipette

## Column definition for miscellaneous commands (to be updated)
0. Step# (Integral serial, shown in generated protocol)
1. Step Type (heaterShaker|temperature|magnet|thermocycler|pause|control)
2. Comment (Step comment at the top row of each step)
3. Command target labware (labware API name)
4. Command target slot (str, 1-11 or A1,A2... for future OT Flex support)
5. Command target well (str, optional)
6. Source Volume (µL)
7. Source Name (the last word can be hex color code starting from #)
8. User Friendly Description of command
9. Dest Slot / Command option integral
10. Dest Well / Command option string
11. Dest Volume (µL) / Command option float
12. Dest Name (the last word can be hex color code starting from #)
13. Handling Volume (µL)
14. Change Tip ([blank]/always/per source/per destination/once/never)
15. Aspirate Rate (1-6)
16. Prewet Cycle
17. Source Delay (sec)
18. Source Touch Tip (speed 0.25-1)
19. Source Air Gap (µL)
20. Dispense Rate (1-6)
21. Pipetting Cycle
22. Dest Delay (sec)
23. Dest Touch Tip (speed 0.25-1)
24. Dest Air Gap (uL)
25. Reverse Mode ([blank]/Bin/Source)
26. Distribute (No/Allow/Force [Bin/Source])
27. Pipette

## Mix
- (hidden option, deleted before export) before source
- (hidden option, deleted before export) before step
- mixing cycle and target are indicated by prewet cycle (source) or pipetting cycle (dest) and handling volume specify mixing volume.
- All pipetting options apart from prewet and pipetting follows parent transfer.

## Miscellanoeous Command (step type)
(heaterShaker|temperature|magnet|thermocycler|pause|control)
- Temperature Module Control
- Magnetic Module Control
- Thermocycler Module Control
- Heater-Shaker Module Control
- Pause
- Other control (Home)
### Temperature Module Control
#### Dest Well
- deactivate
- start
#### Dest Volume
- Target temperature (4-95)
#### Comment (Description)
- Temperature Module (Slot [Destination Slot]): Set temperature at [Source Volume] degree Celsius
- Temperature Module (Slot [Destination Slot]): Start setting temperature at [Source Volume] degree Celsius
- Temperature Module (Slot [Destination Slot]): Deactivate
### Magnetic Module Control
#### Dest Well 
- disengage
- engage
#### Dest Volume
- height from bottom
#### Comment (Description)
- Magnetic Module (Slot [Destination Slot]): Disengage
- Magnetic Module (Slot [Destination Slot]): Engage labware default
- Magnetic Module (Slot [Destination Slot]): Engage at [Source Volume] mm from base
### Pause
#### Dest Slot
- Waiting time in seconds (blank or 0 stands for resume manually)
#### Dest Well (multiple options allowed separated by space)
- beep
- temperature
- (hidden option, deleted before export) before source
- (hidden option, deleted before export) before step 
#### Dest Volume
- Target temperature
#### Comment (Description)
- Pause: Resume manually from Opentrons app.
- Pause: Pause for hh hr mm min ss sec. 
- Pause: Pause for hh:mm:ss. Beep On.
- Pause: Pause until Temperature module in slot [Destination Slot] reaches [Source Volume] degree Celsius
- Pause: Pause until Heater-Shaker module in slot [Destination Slot] reaches [Source Volume] degree Celsius 
### Heater-Shaker Module Control
#### Dest Slot
- Target speed (200-3000)
#### Dest Well (multiple options allowed)
- deactivate_heater
- deactivate_shaker
- start_heater (set temeprature and not wait until temmpareture reaches)
- lock
- unlock
#### Dest Volume
- Target temperature (37-95)
#### Comment (Description)
- Heater-Shaker Module (Slot [Destination Slot]): Set temperature at [Source Volume] degree Celsius
- Heater-Shaker Module (Slot [Destination Slot]): Start setting temperature at [Source Volume] degree Celsius
- Heater-Shaker Module (Slot [Destination Slot]): Deactivate Heater
- Heater-Shaker Module (Slot [Destination Slot]): Set shaking speed at [Source Slot] rpm
- Heater-Shaker Module (Slot [Destination Slot]): Set shaking speed at [Source Slot] rpm and set temperature at [Source Volume] degree Celsius
- Heater-Shaker Module (Slot [Destination Slot]): Set shaking speed at [Source Slot] rpm and start setting temperature at [Source Volume] degree Celsius
- Heater-Shaker Module (Slot [Destination Slot]): Open Latch
- Heater-Shaker Module (Slot [Destination Slot]): Close Latch
### Thermocycler Module Control
Specifically this module is controled by multiple steps. Lid and block temperature should be specified by separated command step.
Thermocycler module and the labware in the thermocycler is always in slot 7.
#### Dest Slot
- Hold time in sec
- Block max volume 
#### Dest Well (multiple options allowed)
- deactivate_block
- deactivate_lid
- block (can not be used with lid)
- lid (can not be used with block)
- open_lid
- close_lid
- execute_profile (profile can not be used with other options. Specify profile filename in the second argument)
#### Dest Volume
- Target temperature (Block:4-99; Lid: 37-110)
- Repetition of profile (converted to integral in the Python script)
#### Comment (Description)
- Thermocycler Module (Vol: [Source Slot]): Deactivate block
- Thermocycler Module (Vol: [Source Slot]): Deactivate lid
- Thermocycler Module: Set [lid/block] temperature at [Source Volume] degree Celsius
- Thermocycler Module: Set [lid/block] temperature at [Source Volume] degree Celsius and hold hh hr mm min ss sec (if hold option applied)
- Thermocycler Module (Vol: [Source Slot]): Set [block] temperature at [Source Volume] degree Celsius
- Thermocycler Module (Vol: [Source Slot]): Open lid
- Thermocycler Module (Vol: [Source Slot]): Close lid
- Thermocycler Module (Vol: [Source Slot]): Execute profile ([Source Well]) for [Source Volume] time(s)
